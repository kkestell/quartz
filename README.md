# Quartz & Zircon

Quartz & Zircon form an end-to-end toolchain for a custom programming language. It includes Quartz, a high-level, imperative language, and Zircon, a cross-platform, stack-based virtual machine that runs the compiled Quartz bytecode.

## Quartz

Quartz is a simple, dynamically-typed, imperative language.

### Example

A program to calculate the 10th Fibonacci number:

```text
fib(n) {
  if (n <= 1) {
    return n;
  }
  
  return fib(n - 1) + fib(n - 2);
}

main() {
  return fib(10);
}
```

### Compilation Pipeline

The Quartz compiler transforms source code into Zircon bytecode through the following stages:

1.  **Lexing & Parsing**: The source code is tokenized and parsed into an Abstract Syntax Tree (AST).
2.  **Lowering to IR**: The AST is converted into a lower-level Intermediate Representation (IR) for analysis and optimization.
3.  **Bytecode Emission**: The IR is translated into Zircon bytecode, ready for execution by the virtual machine.

## Zircon

Zircon is a stack-based virtual machine designed to execute bytecode generated by the Quartz compiler.

### Zircon Bytecode

#### Bytecode File Format

A compiled `.zirc` file has the following binary structure:

1.  **Magic Number**: A 4-byte sequence (`ZRCN`) to identify the file type.
2.  **Version**: A single byte indicating the bytecode version.
3.  **Constant Pool**: A table of constants (numbers, strings) used by the program.
    * `uint32`: Number of constants.
    * For each constant:
        * `byte`: Type of the constant.
        * `...`: The constant's value.
4.  **Functions**: A table of all functions defined in the program.
    * `uint32`: Number of functions.
    * For each function:
        * `int32`: Number of arguments.
        * `uint32`: Number of instructions.
        * For each instruction:
            * `byte`: The opcode.
            * `ushort` (optional): The operand, if the opcode requires one.

#### Bytecode Reference

<table>
    <thead>
        <tr>
            <th>Opcode</th>
            <th>Hex</th>
            <th>Operand(s)</th>
            <th>Description</th>
        </tr>
    </thead>
    <tbody>
        <tr><td colspan="4"><strong>Stack Operations</strong></td></tr>
        <tr>
            <td><code>PushConst</code></td>
            <td><code>0x01</code></td>
            <td>2-byte const index</td>
            <td>Pushes a constant from the constant pool onto the stack.</td>
        </tr>
        <tr>
            <td><code>Pop</code></td>
            <td><code>0x02</code></td>
            <td>None</td>
            <td>Pops the top value from the stack.</td>
        </tr>
        <tr>
            <td><code>Dup</code></td>
            <td><code>0x03</code></td>
            <td>None</td>
            <td>Duplicates the value at the top of the stack.</td>
        </tr>
        <tr>
            <td><code>Swap</code></td>
            <td><code>0x04</code></td>
            <td>None</td>
            <td>Swaps the top two values on the stack.</td>
        </tr>
        <tr>
            <td><code>PushNil</code></td>
            <td><code>0x05</code></td>
            <td>None</td>
            <td>Pushes a <code>nil</code> value onto the stack.</td>
        </tr>
        
        <tr><td colspan="4"><strong>Arithmetic</strong></td></tr>
        <tr>
            <td><code>Add</code></td>
            <td><code>0x10</code></td>
            <td>None</td>
            <td>Pops two numbers, adds them, and pushes the result.</td>
        </tr>
        <tr>
            <td><code>Subtract</code></td>
            <td><code>0x11</code></td>
            <td>None</td>
            <td>Pops two numbers, subtracts the top from the second, and pushes the result.</td>
        </tr>
        <tr>
            <td><code>Multiply</code></td>
            <td><code>0x12</code></td>
            <td>None</td>
            <td>Pops two numbers, multiplies them, and pushes the result.</td>
        </tr>
        <tr>
            <td><code>Divide</code></td>
            <td><code>0x13</code></td>
            <td>None</td>
            <td>Pops two numbers, divides the second by the top, and pushes the result.</td>
        </tr>
        <tr>
            <td><code>Modulo</code></td>
            <td><code>0x14</code></td>
            <td>None</td>
            <td>Pops two numbers, performs modulo, and pushes the result.</td>
        </tr>
        <tr>
            <td><code>Negate</code></td>
            <td><code>0x15</code></td>
            <td>None</td>
            <td>Pops a number, negates it, and pushes the result.</td>
        </tr>
        
        <tr><td colspan="4"><strong>Logical Operations</strong></td></tr>
        <tr>
            <td><code>And</code></td>
            <td><code>0x20</code></td>
            <td>None</td>
            <td>Pops two booleans, performs a logical AND, and pushes the result.</td>
        </tr>
        <tr>
            <td><code>Or</code></td>
            <td><code>0x21</code></td>
            <td>None</td>
            <td>Pops two booleans, performs a logical OR, and pushes the result.</td>
        </tr>
        <tr>
            <td><code>Not</code></td>
            <td><code>0x22</code></td>
            <td>None</td>
            <td>Pops a boolean, inverts it, and pushes the result.</td>
        </tr>
        
        <tr><td colspan="4"><strong>Comparison Operations</strong></td></tr>
        <tr>
            <td><code>Equal</code></td>
            <td><code>0x30</code></td>
            <td>None</td>
            <td>Pops two values, checks for equality, and pushes the boolean result.</td>
        </tr>
        <tr>
            <td><code>GreaterThan</code></td>
            <td><code>0x31</code></td>
            <td>None</td>
            <td>Pops two numbers, compares them (<code>&gt;</code>), and pushes the boolean result.</td>
        </tr>
        <tr>
            <td><code>LessThan</code></td>
            <td><code>0x32</code></td>
            <td>None</td>
            <td>Pops two numbers, compares them (<code>&lt;</code>), and pushes the boolean result.</td>
        </tr>
        
        <tr><td colspan="4"><strong>Control Flow</strong></td></tr>
        <tr>
            <td><code>Jump</code></td>
            <td><code>0x40</code></td>
            <td>2-byte address</td>
            <td>Sets the instruction pointer to the specified address.</td>
        </tr>
        <tr>
            <td><code>JumpIfTrue</code></td>
            <td><code>0x41</code></td>
            <td>2-byte address</td>
            <td>Pops a value; if true, jumps to the specified address.</td>
        </tr>
        <tr>
            <td><code>JumpIfFalse</code></td>
            <td><code>0x42</code></td>
            <td>2-byte address</td>
            <td>Pops a value; if false, jumps to the specified address.</td>
        </tr>
        
        <tr><td colspan="4"><strong>I/O</strong></td></tr>
        <tr>
            <td><code>Print</code></td>
            <td><code>0x60</code></td>
            <td>None</td>
            <td>Pops a value and prints its string representation to the console.</td>
        </tr>
        
        <tr><td colspan="4"><strong>Variables</strong></td></tr>
        <tr>
            <td><code>GetLocal</code></td>
            <td><code>0x70</code></td>
            <td>2-byte local index</td>
            <td>Pushes the value of a local variable onto the stack.</td>
        </tr>
        <tr>
            <td><code>SetLocal</code></td>
            <td><code>0x71</code></td>
            <td>2-byte local index</td>
            <td>Pops a value and assigns it to a local variable.</td>
        </tr>
        <tr>
            <td><code>GetGlobal</code></td>
            <td><code>0x72</code></td>
            <td>2-byte global index</td>
            <td>Pushes the value of a global variable onto the stack.</td>
        </tr>
        <tr>
            <td><code>SetGlobal</code></td>
            <td><code>0x73</code></td>
            <td>2-byte global index</td>
            <td>Pops a value and assigns it to a global variable.</td>
        </tr>
        
        <tr><td colspan="4"><strong>Functions</strong></td></tr>
        <tr>
            <td><code>Call</code></td>
            <td><code>0x80</code></td>
            <td>2-byte function index</td>
            <td>Calls a function, setting up a new call frame.</td>
        </tr>
        <tr>
            <td><code>Return</code></td>
            <td><code>0x81</code></td>
            <td>None</td>
            <td>Returns from the current function.</td>
        </tr>
        
        <tr><td colspan="4"><strong>Array Operations</strong></td></tr>
        <tr>
            <td><code>NewArray</code></td>
            <td><code>0x90</code></td>
            <td>None</td>
            <td>Pops a size, creates an array, and pushes it onto the stack.</td>
        </tr>
        <tr>
            <td><code>GetElement</code></td>
            <td><code>0x91</code></td>
            <td>None</td>
            <td>Pops an index and an array, and pushes the element at that index.</td>
        </tr>
        <tr>
            <td><code>SetElement</code></td>
            <td><code>0x92</code></td>
            <td>None</td>
            <td>Pops a value, an index, and an array, and sets the element.</td>
        </tr>
        <tr>
            <td><code>ArrayLength</code></td>
            <td><code>0x93</code></td>
            <td>None</td>
            <td>Pops an array and pushes its length.</td>
        </tr>
        
        <tr><td colspan="4"><strong>Object Operations</strong></td></tr>
        <tr>
            <td><code>NewObject</code></td>
            <td><code>0xA0</code></td>
            <td>None</td>
            <td>Creates a new, empty object (dictionary) and pushes it.</td>
        </tr>
        <tr>
            <td><code>GetProperty</code></td>
            <td><code>0xA1</code></td>
            <td>2-byte const index</td>
            <td>Pops an object, gets a property by name (from const pool), and pushes it.</td>
        </tr>
        <tr>
            <td><code>SetProperty</code></td>
            <td><code>0xA2</code></td>
            <td>2-byte const index</td>
            <td>Pops a value and an object, and sets a property by name.</td>
        </tr>
        
        <tr><td colspan="4"><strong>VM Control</strong></td></tr>
        <tr>
            <td><code>Halt</code></td>
            <td><code>0xFF</code></td>
            <td>None</td>
            <td>Stops the virtual machine.</td>
        </tr>
    </tbody>
</table>

## License

Permission to use, copy, modify, and/or distribute this software for
any purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES
OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE
FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY
DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN
AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT
OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
